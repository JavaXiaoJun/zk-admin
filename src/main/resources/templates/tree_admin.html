<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>zk admin</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
</head>
<link href="../vender/bootstrap-3.3.7-dist/css/bootstrap.min.css" rel="stylesheet" charset="utf-8" />
<link rel="stylesheet" href="../vender/jstree/dist/themes/default/style.min.css" />
<link href="../css/common.css" rel="stylesheet" charset="utf-8" />
<!-- 4 include the jQuery library -->
<script src="../vender/jQuery/jquery-2.2.3.min.js"></script>
<!-- 5 include the minified jstree source -->
<script src="../vender/jstree/dist/jstree.min.js"></script>
<style>
    div.input-group > .glyphicon-search{
        top:0px;
    }
    .right-content > .panel-footer, .right-content > .panel-heading{
        padding: 4px 4px;
    }
    .right-content > .panel-footer{
        background-color: #fafbfc;
        border-color: #e1e4e8;
    }

    pre {padding: 5px; margin: 0px; margin-bottom: 15px }
    .string { color: green; }
    .number { color: darkorange; }
    .boolean { color: blue; }
    .null { color: magenta; }
    .key { color: red; }
</style>
<body>
<nav class="navbar navbar-inverse navbar-fixed-top">
    <!-- We use the fluid option here to avoid overriding the fixed width of a normal container within the narrow content columns. -->
    <div class="container">

        <div class="navbar-header">
            <a class="navbar-brand" href="/tree/admin"><span class="glyphicon glyphicon-home"></span> Home</a>
        </div>

        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-6">
            <ul class="nav navbar-nav">
                <li><a href="/tree/config">Config-center</a></li>
                <li><a href="/tree/ha">HA-service</a></li>
                <li><a href="/tree/timer">Timer</a></li>
            </ul>
        </div><!-- /.navbar-collapse -->

    </div>
</nav>
<div class="clearfix nav-height"></div>
<div class="container-fluid container-title">
    <div class="container container-title-content">
        <h1>zk-admin</h1>
        <p>zookeeper admin center</p>
    </div>
</div>
<div class="container">
    <div class="row">
        <div class="col-md-3">
            <div class="panel panel-default">
                <div class="panel-body">
                    <div class="input-group">
                        <span class="input-group-addon glyphicon glyphicon-search"></span>
                        <input type="text" class="form-control" id="demo_q" placeholder="Search" />
                    </div>
                    <div id="jstree"></div>
                </div>
            </div>
        </div><!-- .col-md-2 -->
        <div class="col-md-9">
            <div class="panel panel-default right-content">
                <div class="panel-heading">
                    <button type="button" class="btn btn-default btn-sm" onclick="demo_create();"><i class="glyphicon glyphicon-plus"></i> Create</button>
                    <button type="button" class="btn btn-default btn-sm" onclick="demo_rename();"><i class="glyphicon glyphicon-erase"></i> Rename</button>
                    <button type="button" class="btn btn-default btn-sm" onclick="demo_delete();"><i class="glyphicon glyphicon-remove"></i> Delete</button>
                    <button type="button" class="btn btn-default btn-sm" id="save-current-path"><i class="glyphicon glyphicon-ok"></i>save</button>
                    <button type="button" class="btn btn-default btn-sm" id="save-all-path"><i class="glyphicon glyphicon-saved"></i>save-all</button>
                </div>
                <div class="panel-body">
                    <pre id="node-detail" data-url=""></pre>
                    <div class="node-value text-value">
                        <textarea class="form-control node-value" rows="3" id="node-data"></textarea>
                    </div>
                    <div class="node-value table-value"></div>
                    <div class="node-value json-value"></div>
                </div>
                <div class="panel-footer">
                    <button type="button" class="btn btn-default btn-sm" id="node-table">table</button>
                    <button type="button" class="btn btn-default btn-sm" id="node-json">json</button>
                    <button type="button" class="btn btn-default btn-sm" id="node-children-table">children-table</button>
                    <button type="button" class="btn btn-default btn-sm" id="node-children-json">children-json</button>
                </div>
            </div>
        </div>
    </div><!-- .row -->
</div><!-- .container-fluid -->


<script th:inline="JavaScript">
    /*<![CDATA[*/
    function demo_create() {
        var ref = $('#jstree').jstree(true),
                sel = ref.get_selected();
        if(!sel.length) { return false; }
        sel = sel[0];
        sel = ref.create_node(sel, {"type":"file"});
        if(sel) {
            ref.edit(sel);
        }
    };
    function demo_rename() {
        var ref = $('#jstree').jstree(true),
                sel = ref.get_selected();
        if(!sel.length) { return false; }
        sel = sel[0];
        ref.edit(sel);
    };
    function demo_delete() {
        var ref = $('#jstree').jstree(true),
                sel = ref.get_selected();
        if(!sel.length) { return false; }
        ref.delete_node(sel);
    };

    $("#save-current-path").click(function () {
        var reqdata = {};
        reqdata.path = $("#node-detail").data("url");
        reqdata.nodeData = $("#node-data").val();
        $.ajax({
            type : "post",
            contentType: 'application/json',
            url : "/tree/update_path_data_ajax",
            data : JSON.stringify(reqdata),
            dataType:'json',
            success : function(data){
                $("#node-detail").html(syntaxHighlight(data["stat"]));
                $("#node-data").val( JSON.stringify(data["data"]) );
            }
        });
    });

    $("#save-all-path").click(function () {
        var reqdata = {};
        reqdata.path = $("#node-detail").data("url");
        reqdata.nodeData = $("#node-data").val();
        $.ajax({
            type : "post",
            contentType: 'application/json',
            url : "/tree/update_all_path_data_ajax",
            data : JSON.stringify(reqdata),
            dataType:'json',
            success : function(data){
                $("#node-detail").html(syntaxHighlight(data["stat"]));
                $("#node-data").val( JSON.stringify(data["data"]) );
            }
        });
    });

    $(function () {
        var to = false;
        $('#demo_q').keyup(function () {
            if(to) { clearTimeout(to); }
            to = setTimeout(function () {
                var v = $('#demo_q').val();
                $('#jstree').jstree(true).search(v);
            }, 250);
        });

        var get_all_url = getUrlParam('path');
        if( typeof get_all_url == "undefined" || get_all_url == null ){
            get_all_url = "/";
        }
        $('#jstree').jstree({
            "core" : {
                "animation" : 0,
                "check_callback" : true,
                "themes" : { "stripes" : false },
                'data' : {
                    'url' : function (node) {
                        return '/tree/get_all_path_ajax?path=' + get_all_url;
                    },
                    'data' : function (node) {
                        return { 'id' : node.id };
                    }
                }
            },
            "types" : {
                "default" : {
                    "icon" : "glyphicon glyphicon-flash",
                    "valid_children" : []
                },
                "file" : {
                    "icon" : "glyphicon glyphicon-flash",
                    "valid_children" : []
                },
                "root" : {
                    "icon" : "glyphicon glyphicon-ok",
                    "valid_children" : ["default","file"]
                }
            },
            "plugins" : [ "contextmenu", "search", "state", "types" ]
        });


        $('#jstree').on("changed.jstree", function (e, data) {
            console.log(data.selected);
            var path = data.selected[0];
            $("#node-detail").data("url", path);
            console.log(path);
            $.get("/tree/get_path_detail_ajax?path=" + path,function(data){
                $("#node-detail").html(syntaxHighlight(data["stat"]));
                $("#node-data").val( JSON.stringify(data["data"]) );
            });
        });

    });

    function getUrlParam(name) {
        var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)"); //构造一个含有目标参数的正则表达式对象
        var r = window.location.search.substr(1).match(reg);  //匹配目标参数
        if (r != null) return unescape(r[2]);
        return null; //返回参数值
    }

    function syntaxHighlight(json) {
        if( typeof json == 'undefined'){
            return "";
        }
        if (typeof json != 'string') {
            json = JSON.stringify(json, undefined, 2);
        }
        json = json.replace(/&/g, '&').replace(/</g, '<').replace(/>/g, '>');
        return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function(match) {
            var cls = 'number';
            if (/^"/.test(match)) {
                if (/:$/.test(match)) {
                    cls = 'key';
                } else {
                    cls = 'string';
                }
            } else if (/true|false/.test(match)) {
                cls = 'boolean';
            } else if (/null/.test(match)) {
                cls = 'null';
            }
            return '<span class="' + cls + '">' + match + '</span>';
        });
    }
    /*]]>*/
</script>
</body>
</html>